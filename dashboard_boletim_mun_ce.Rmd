---
title: "Boletim Fiscal dos Municípios Cearenses"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    logo: 
    orientation: columns
    vertical_layout: fill
    theme:
      bootswatch: lumen
      bg: "#FFFFFF"
      fg: "#000000" 
      primary: "#2FA4E7"
      secondary: "#E9ECEF"
      success: "#73A839"
      info: "#033C73"
      base_font: !expr bslib::font_google("Prompt")
      code_font: !expr bslib::font_google("JetBrains Mono")
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.path = "figs/",
  cache.path = "_cache/",
  fig.process = function(x) {
    x2 <- sub("-\\d+([.][a-z]+)$", "\\1", x)
    if (file.rename(x, x2)) x2 else x
  }
)
```

```{r loadlibaries, include=FALSE}

library(flexdashboard)
library(tidyverse)
library(clock)
library(shiny)
library(scales)
library(DT)

bslib::bs_themer()

thematic::thematic_rmd(
  font = "auto",
  # To get the dark bg on the geom_raster()
  sequential = thematic::sequential_gradient(fg_low = FALSE, fg_weight = 0, bg_weight = 1)
)

theme_set(theme_bw(base_size = 20))

```

```{r data}

indicadores <- read_rds(
  here::here('out/indicadores/indicadores_mun_ce.rds')
)


balancete_uf <- readr::read_rds(
    here::here(
    "out/dados_consolidados/balancetes/quadrimestral/balancete_uf_quadrimestral.rds"
  )
)

balancete_mun <- readr::read_rds(
    here::here(
    "out/dados_consolidados/balancetes/quadrimestral/balancete_mun_quadrimestral.rds"
  )
)


```

Estado do Ceará
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

### Parâmetros

```{r}

nome_mun <- indicadores %>% 
  count(mun)

ano <- indicadores %>% 
  count(ano)

quadrimestre <- indicadores %>% 
  count(quadrimestre)

sliderInput("contact_rate", "Set contact rate", value = 5, min = 0, max = 30)

selectInput('indicador_fiscal', 'Indicadores Fiscais', names(indicadores)[7:11])

selectInput('ano', 'Ano', ano$ano, selected = '2021')

selectInput('quad', 'Quadrimestre', quadrimestre$quadrimestre)


```



Column {data-width=650}
-----------------------------------------------------------------------

### Balancete do Estado do Ceará

```{r table_ce, cache=FALSE}

renderTable({
  
    data_atual <- clock::date_build(
    year = as.numeric(input$ano),
    month = case_when(
      input$quad == "1" ~ 4,
      input$quad == "2" ~ 8,
      input$quad == "3" ~ 12
    )
  )

  data_defasada <- clock::add_months(data_atual, -12)

  variacao_uf <- balancete_uf %>%
    filter(
      date %in% c(data_atual, data_defasada)
    ) %>%
    group_by(conta) %>%
    mutate(
      variacao = (valor / lag(valor)) - 1
    ) %>% 
    ungroup() %>% 
    drop_na(variacao) %>% 
    select(conta, variacao)
  
    balancete_uf %>%
    filter(
      date %in% c(data_atual, data_defasada)
    ) %>%
    mutate(
      date = format(date, 'p%Y%m'),
      quadrimestre = as.character(quadrimestre)
      ) %>%
    select(conta, date, valor) %>%
    pivot_wider(
      names_from = date, 
      values_from = valor
      ) %>%
    left_join(variacao_uf, by = 'conta') %>%
    mutate(
      variacao = scales::percent(
        variacao, 
        accuracy = 0.01,
        big.mark = '.', 
        decimal.mark = ',')
    ) %>% 
    mutate(
      across(
        !c(conta, variacao), 
        ~scales::comma(., prefix = 'R$ ', big.mark = '.', decimal.mark = ','))
      ) %>% 
    rename(Conta = conta, 'Var.%' = variacao) 
  
})

```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r plot_1, cache=FALSE}

shiny::renderPlot({
  
  indicadores %>% 
  filter(ano == input$ano, quadrimestre == input$quad) %>% 
  ggplot(aes_string(x = input$indicador_fiscal)) +
  geom_histogram(bins = 5)
  
})


```

### Chart C

```{r}

```



Municípios Cearenses
=======================================================================


Column {.sidebar}
-----------------------------------------------------------------------

### Parâmetros

```{r}

nome_mun <- indicadores %>% 
  count(mun)

ano <- indicadores %>% 
  count(ano)

quadrimestre <- indicadores %>% 
  count(quadrimestre)

selectInput('indicador_fiscal_mun', 'Indicadores Fiscais', names(indicadores)[7:11])

selectInput('mun', 'Municípios Cearenses', nome_mun$mun, selected = 'Fortaleza')

selectInput('ano_mun', 'Ano', ano$ano, selected = '2021')

selectInput('quad_mun', 'Quadrimestre', quadrimestre$quadrimestre)

```



Column {data-width=600}
-----------------------------------------------------------------------

### Balancete dos Municípios Cearenses

```{r table_mun, cache=FALSE}


renderTable({
  data_atual <- clock::date_build(
    year = as.numeric(input$ano_mun),
    month = case_when(
      input$quad_mun == "1" ~ 4,
      input$quad_mun == "2" ~ 8,
      input$quad_mun == "3" ~ 12
    )
  )

  data_defasada <- clock::add_months(data_atual, -12)

  variacao_mun <- balancete_mun %>%
    filter(
      date %in% c(data_atual, data_defasada),
      mun == input$mun
    ) %>%
    group_by(conta) %>%
    mutate(
      variacao = (valor / lag(valor)) - 1
    ) %>% 
    ungroup() %>% 
    drop_na(variacao) %>% 
    select(conta, variacao)
    

  balancete_mun %>%
    filter(
      date %in% c(data_atual, data_defasada),
      mun == input$mun
    ) %>%
    mutate(
      date = format(date, 'p%Y%m'),
      quadrimestre = as.character(quadrimestre)
      ) %>%
    select(conta, date, valor) %>%
    pivot_wider(
      names_from = date, 
      values_from = valor
      ) %>%
    left_join(variacao_mun, by = 'conta') %>%
    mutate(
      variacao = scales::percent(
        variacao, 
        accuracy = 0.01,
        big.mark = '.', 
        decimal.mark = ',')
    ) %>% 
    mutate(
      across(
        !c(conta, variacao), 
        ~scales::comma(., prefix = 'R$ ', big.mark = '.', decimal.mark = ','))
      ) %>% 
    rename(Conta = conta, 'Var.%' = variacao) 
})

```

Column {data-width=350}
-----------------------------------------------------------------------

### Ano Corrente

```{r plot_mun_1, cache=FALSE}

shiny::renderPlot({
  
  indicadores %>% 
  filter(ano == input$ano, quadrimestre == input$quad) %>% 
  ggplot(aes_string(x = input$indicador_fiscal)) +
  geom_histogram(bins = 5)
  
})

```

### Mesmo Período do Ano Anterior

```{r}

```


Indicadores
=======================================================================

```{r}

datatable(
  indicadores %>% select(-mes),
  extensions = "Buttons",
  options = list(
    dom = "Bfrtip",
    buttons = c("copy", "csv", "excel", "print", "pdf")
  ),
  rownames = FALSE
)

```

Balancetes Municipais
=======================================================================

```{r balancetes_download}

datatable(
  balancete_mun %>% select(-mes),
  extensions = "Buttons",
  options = list(
    dom = "Bfrtip",
    buttons = c("copy", "csv", "excel", "print", "pdf")
  ),
  rownames = FALSE
)

```



